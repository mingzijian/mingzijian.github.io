RocketMQ - 特性(features)
----------------------------------------
### 发布订阅

### 有序消息

消息有序指的是一类消息消费时，能按照发送的顺序来消费。例如：一个订单产生了三条消息分别是订单创建、订单付款、订单完成。消费时要按照这个顺序消费才能有意义，但是同时订单之间是可以并行消费的。RocketMQ可以严格的保证消息有序。

顺序消息分为全局顺序消息与分区顺序消息，全局顺序是指某个Topic下的所有消息都要保证顺序；部分顺序消息只要保证每一组消息被顺序消费即可。

- 全局顺序 对于指定的一个 Topic，所有消息按照严格的先入先出（FIFO）的顺序进行发布和消费。 适用场景：性能要求不高，所有的消息严格按照 FIFO 原则进行消息发布和消费的场景
- 分区顺序 对于指定的一个 Topic，所有消息根据 sharding key 进行区块分区。 同一个分区内的消息按照严格的 FIFO 顺序进行发布和消费。 Sharding key 是顺序消息中用来区分不同分区的关键字段，和普通消息的 Key 是完全不同的概念。 适用场景：性能要求高，以 sharding key 作为分区字段，在同一个区块中严格的按照 FIFO 原则进行消息发布和消费的场景。

### 消息过滤

消费者订阅了某个主题后，Apache RocketMQ 会将该主题中的所有消息投递给消费者。若消费者只需要关注部分消息，可通过设置过滤条件在 Apache RocketMQ **服务端进行过滤**，只获取到需要关注的消息子集，避免接收到大量无效的消息。

过滤的含义指的是**将符合条件的消息投递给消费者，而不是将匹配到的消息过滤掉**。

![消息过滤](https://gitee.com/mingzijian/resources/raw/master/picgo/2024-03/messagefilter0-ad2c8360f54b9a622238f8cffea12068.png)

### 可靠消息

RocketMQ支持消息的高可靠，影响消息可靠性的几种情况：

1. Broker非正常关闭
2. Broker异常Crash
3. OS Crash
4. 机器掉电，但是能立即恢复供电情况
5. 机器无法开机（可能是cpu、主板、内存等关键设备损坏）
6. 磁盘设备损坏

1)、2)、3)、4) 四种情况都属于硬件资源可立即恢复情况，RocketMQ在这四种情况下能保证消息不丢，或者丢失少量数据（依赖刷盘方式是同步还是异步）。

5)、6)属于单点故障，且无法恢复，一旦发生，在此单点上的消息全部丢失。RocketMQ在这两种情况下，通过异步复制，可保证99%的消息不丢，但是仍然会有极少量的消息可能丢失。通过**同步双写**技术可以完全避免单点，同步双写势必会影响性能，适合对消息可靠性要求极高的场合，例如与 Money 相关的应用。

> 注：RocketMQ从3.0版本开始支持同步双写。

### 至少一次

### 回溯消费

### 事务机制

![事务消息1](https://gitee.com/mingzijian/resources/raw/master/picgo/2024-03/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF1-15b51f54e4cb4280459be1df277c288e.png)

![事务消息2](https://gitee.com/mingzijian/resources/raw/master/picgo/2024-03/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF2-2673a99678f13a471b8fc0bd4ab3bf3a.png)

### 定时消息(延时队列)

### 重试机制

**重试状态机**

![image-20240328120306255](https://gitee.com/mingzijian/resources/raw/master/picgo/2024-03/image-20240328120306255.png)

**最大重试次数**

PushConsumer的最大重试次数由消费者分组创建时的元数据控制，具体参数，请参见[消费者分组](https://rocketmq.apache.org/zh/docs/domainModel/07consumergroup)。

例如，最大重试次数为3次，则该消息最多可被投递4次，1次为原始消息，3次为重试投递次数。

**重试间隔时间**

- 无序消息（非顺序消息）：重试间隔为阶梯时间，具体时间如下：

  | 第几次重试 | 与上次重试的间隔时间 | 第几次重试 | 与上次重试的间隔时间 |
  | ---------- | -------------------- | ---------- | -------------------- |
  | 1          | 10秒                 | 9          | 7分钟                |
  | 2          | 30秒                 | 10         | 8分钟                |
  | 3          | 1分钟                | 11         | 9分钟                |
  | 4          | 2分钟                | 12         | 10分钟               |
  | 5          | 3分钟                | 13         | 20分钟               |
  | 6          | 4分钟                | 14         | 30分钟               |
  | 7          | 5分钟                | 15         | 1小时                |
  | 8          | 6分钟                | 16         | 2小时                |



> 若重试次数超过16次，后面每次重试间隔都为2小时。

### 消息重投

### 流量控制

### 死信队列