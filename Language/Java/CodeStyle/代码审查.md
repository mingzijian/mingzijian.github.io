

## Google 代码审查



### [如何做一个代码评审](https://github.com/google/eng-practices/blob/master/review/reviewer/index.md)
#### [代码审查的标准](https://github.com/google/eng-practices/blob/master/review/reviewer/standard.md)

1、技术事实和数据高于(overrule)观点和个人偏好；
2、代码风格规范是决对的权威：应当保持风格一致，如果没有规范，就接受原作者的；
3、除了风格，应当关注软件设计的原则，除非有正当的数据支撑，不应当违背设计原则；
4、没有规范时，可以保持一致，满足对代码健康度不劣化的目标。

#### [代码审查需要关注的内容](https://github.com/google/eng-practices/blob/master/review/reviewer/looking-for.md)

##### 1、好的代码设计

修改的代码是否都有意义？分别归属什么版本库？是否和系统集成一致？从设计层面考虑代码是否符合好的标准。

##### 2、功能正确

确保功能正确，不仅指交付给终端用户，还要考虑代码未来的开发者，对UI的变更保证可视(demo)与美观，审查要考虑并发编程的安全可靠，考虑边界条件等，即使应该已经有测试用例来保证。

##### 3、代码不应该比它所需的更复杂

复杂性要从代码行、函数、类等多个维度去考虑，导致代码复杂度增加常见有以下场景：
· 过度的代码设计（over-engineering）
· 解决当前的问题而不是解决未来的问题
代码的复杂度会直接影响代码的可读性和可维护性，也更容易在变更的时候引入问题。

##### 4、单元测试

单元测试应当和提交的功能代码在同一个CL中提交；
单元测试本身不会被测试，编写测试用例的人应当保证正确，有意义；
单元测试本身也是代码库中的一部分，所以不要增加测试用例的复杂度。

##### 5、命名

编码过程中有一半的时间在命名，确保命名清晰准确、有意义。

##### 6、注释

注释应当解释why，而不是仅仅是说明what。

##### 7、代码文档

变更代码的同时，变更相关的文档。

##### 8、代码风格

遵循代码风格，代码风格的重构和功能CL应该拆分提交，先重构风格，再提交功能CL。

对代码变更的每一行做审查，同时要结合代码的上下文（Context）而不只是工具展示出来的变更部分，这样才能判断出增加了几行，是否应该把一个超过50行的函数拆分成更小的函数。另外的建议除了聚焦错误，对好的代码应该赞赏developer，尤其是将commets修改后的好代码。



#### [CL审查指南](https://github.com/google/eng-practices/blob/master/review/reviewer/navigate.md)

> CL(Change lists)

##### 1、通览整个CL

修改的内容是否有意义。如果没有意义，要有礼貌的拒绝：说明拒绝的原因，给出重构其他代码的建议。如果此类CL很多，就应当贴出通告，在大家投入之前声明”此项目即将废弃/进入维护周期，不接纳功能变更的CL“。

##### 2、审查重点部分

找到CL中最重要的部分，通常是变更内容最多的文件。如果CL大到无法找到重点，则要求developer告知最重要的地方，或者要求其拆分成多个CL。
查看最重要的部分是否有设计问题，如果有应当立即将comments反馈给开发者，防止他们在原有错误流程上进行更多的工作，并且在deadline前重新完成交付。此时不需要审查CL中剩余部分的代码。

##### 3、以合适的顺序审查剩余的部分

以合适的顺序，通常是按照文件的顺审查剩下的部分，确保不要遗漏任何一行需要监视的代码。

#### [代码评审的速度](https://github.com/google/eng-practices/blob/master/review/reviewer/speed.md)

当代码审查进行的很慢时，可能发生了：
1、整个团队的效率下降了；
2、开发人员开始抗议代码审查（day级的响应并打回CL，导致开发人员的抱怨）
3、代码质量下降。

##### 1、代码审查应该多快

收到代码审查申请应该立刻响应，最长不超过一个工作日（通常是在第二个工作日的早晨）

##### 2、如何处理打断

如果在集中精力处理一项任务或者在编码，就不要让code review打断自己，否则会需要小号更多的精力恢复原先的工作。建议在当前工作完成、开完会议、吃午饭回来、早晨刚到工位等时间进行审查。

##### 3、快速的响应

即使CL很大，或者你没有时间进行代码审查，也尽量尽快的响应，并给初步给出一个整体的意见。

##### 4、正向循环

长期坚持代码审查的原则，可以让开发者意识到好代码的要求，代码审查的速度也会越来越快，但是一定不能通过让步代码审查标准来提高审查速度。

#### [如何编写代码评审意见](https://github.com/google/eng-practices/blob/master/review/reviewer/comments.md)

##### 1、保持礼貌

评价代码，而不是评价人。不要用”why did **you** use threads here...“的语句。

##### 2、解释为什么

通常情况下不需要，但是有时候需要解释为什么给出这样的评论。

##### 3、给出指导

通常意义上，修改CL应该是开发者的责任，而不是reviewer。也不要你给出具体的解决代码。但是需要在指明问题和给出直接的指导之间权衡。
记住代码审查的目标，首先是尽可能得到更好的CL，其次的目标是帮助开发者提升技能，以便后续更少的代码审查。

##### 4、接纳说明

不需要修改的审查意见，通常写在审查工具里，对以后的代码读者帮助并不大。除非那个审查意见是单独给reviewer解释，而大部分人明白的代码的含义。通常情况下，你需要找开发理解代码的意思时，应该使开发者重新简化他们的代码。



#### [代码审查处理不同意见](https://github.com/google/eng-practices/blob/master/review/reviewer/pushback.md)

##### 1、谁是正确的？

开发者往往更理解所写的代码，所以应当停下来思考其抗争是否是正确的，如果正确可以接纳CL。
但开发者并不总是正确，此时应当要求其继续修改，直到能达成改进代码健康度的原则。为了避免几个回合中的抱怨，要保持礼貌，同时让开发者知道你在听他们说什么。

##### 2、沮丧的开发者

开发者可能会存在临时的沮丧，但事后会感谢你的帮助。实际上 reviewer 礼貌的评论和快速的响应并不会导致开发者的沮丧。

##### 3、稍后再清理

开发者会请求先合入，稍后再清理。原则应当是”立即清理“
1、对于影响较小的问题，可以再单独提交一个CL，并且是立即的。这不是说开发者不负责，而往往由于太多事情导致遗忘清理，"Later equals Never"。
2、对于引入复杂性的代码，必须清理后才允许合入

##### 4、抱怨”严格“

如果你曾经松懈的审核，现在严格审核，可能会导致极大声的抱怨。加快你的审核速度可以让这种抱怨消失，这个过程有时候需要几个月，或者是在开发者看到你审核价值的时候。

##### 5、解决冲突

并不是解决代码冲突，而是解决审查意见冲突。这个时候去遵循第一章代码审查的原则，它能帮助解决冲突。



### [Google 代码风格指南-Java](https://google.github.io/styleguide/javaguide.html)


