TCP (传输控制协议)
---------------------------
传输控制协议（TCP，Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议。


### 名称解释
#### SYN
同步序列编号（Synchronize Sequence Numbers）。是TCP/IP建立连接时使用的握手信号。
#### ACK
确认 (Acknowledge），表示发来的数据已确认接收无误。
#### PSH
传送(push)
#### FIN
结束（finish）。是TCP/IP断开连接时使用的挥手信号。
#### RST
复位(reset)，用于复位相应的TCP连接。
#### URG
紧急(urgent) ，紧急标志为"1"表明该位有效。
#### ESTABLISHED 
表示TCP连接已经成功建立。
#### Full Duplex
全双工（Full Duplex）是通讯传输的一个术语。通信允许数据在两个方向上同时传输，它在能力上相当于两个单工通信方式的结合。全双工指可以同时（瞬时）进行信号的双向传输（A→B且B→A）。指A→B的同时B→A，是瞬时同步的。
### 连接的建立与断开

![TCP](https://images.gitee.com/uploads/images/2020/0818/134819_1d5d291a_536895.png "TCP.png")

#### 三次握手（建立连接）
建立连接协议
- 客户端发送syn包（seq=j）到服务器，并进入SYN_SENT状态，等待服务器确认
- 服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（seq=k），即SYN+ACK包，此时服务器进入SYN_RECV状态。
- 客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK(ack=k+1），此包发送完毕，客户端和服务器进入ESTABLISHED（TCP连接成功）状态，完成三次握手。
#### 四次挥手 （断开连接）
断开连接协议
-  TCP客户端发送一个FIN，用来关闭客户到服务器的数据传送。
-  服务器收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。
-  服务器关闭客户端的连接，发送一个FIN给客户端。
-  客户端发回ACK报文确认，并将确认序号设置为收到序号加1。

### 问题
#### 为什么断开连接是4次挥手而不是3次？
因为TCP连接通信是全双工的。
当被动方收到主动方发来的的FIN(M)时，被动方仍可能存在需要向主动方发送的数据，
为了避免主动方长时间未收到被动方的回复而重复放送断开连接的请求，
被动方可以先回复一个ACK(M+1),然后继续处理数据，
在处理完数据之后，被动方再发送一个FIN(N)给主动方，
主动方回复ACK(N+1),连接正常断开。
即：在第2次和第3次之间，被动方可能仍需要有时间来处理数据，又不能让主动方一直傻等着。